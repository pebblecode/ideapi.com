# Installation 

To install ideapi from scratch, first clone the source from apu:
    
    git clone git@apu.pebbleit.com:ideapi.com.git

    # Ideapi uses redis so install it through homebrew. If you need to install homebrew
    # follow instructions here: https://github.com/mxcl/homebrew
    brew update
    brew install redis    # Follow post install instructions

    # If you don't have mysql installed 
    brew install mysql
    
    # Change to the directory where you downloaded the ideapi source  
    bundle install # you may need to use `sudo bundle install` depending on your setup

    # Create a database.yml file with relevant account in mysql
        
    # Set up db
    rake db:create    # Required if ideapi db hasn't been created yet
    rake ideapi:bootstrap
    
    
Add this to the /etc/apache2/extra/httpd-vhosts.conf file, replacing [ideapi directory] with the relevant value:
    
    <VirtualHost *:80>
        <Directory [ideapi directory]>
          Options +FollowSymlinks +SymLinksIfOwnerMatch 
          Order allow,deny
          allow from all
          AllowOverride All
        </Directory>
        DocumentRoot [ideapi directory]/public
        ServerName smackaho.st
        ServerAlias *.smackaho.st
        RailsEnv development
    </VirtualHost>
    
## Resque    

ideapi makes use of Resque http://github.com/defunkt/resque to queue background jobs. Resque relies on Redis. 
The Resque README provides instructions on installing Redis.

To ensure that workers do not die (bless them) ideapi also uses monit. The staging and 
production servers are configured to keep workers and Redis alive.

On your development box you will need to have Redis and workers running if you want to use Resque and send email.

To start a work, invoke a worker from the *root of the rails site* using the following command

    QUEUE=* rake environment resque:work

To start the Resque GUI run

    resque-web -p 8282 config/initializers/load_resque.rb 

This shows you workers running and any problems with the jobs you send them. 

If you are not running Redis as a daemon, you can start it with 

    redis-server /usr/local/etc/redis.conf

To kill a worker, find it using ps aux and use kill eg,

    ideapi.com$ ps aux | grep resque
    12:ttt      10928   0.0  0.6  2459144  25140 s005  S     5:56pm   3:17.83 ruby /Users/ttt/.rvm/gems/ree-1.8.7-2011.03@ideapi/bin/resque-web -p 8282 config/initializers/load_resque.rb
    135:ttt      24530   0.0  0.0  2435116    528 s005  S+   11:11am   0:00.00 grep -n resque
    140:ttt      24403   0.0  1.7  2503712  72064 s004  S+   11:05am   0:05.35 resque-1.9.8: Waiting for *

    ideapi.com$ kill 24403


## Gotchas

### http://smackaho.st/ redirects to 404 page

Clear the browser cache. Could occur when you log into ideapi, and then clear out the database. An issue with the cookies.

### ActionController::InvalidAuthenticityToken error when logging in/signing up

Check config/environments/development.rb variable is the same as the url eg,

  config.action_controller.session = { :domain => ".smackaho.st" }
  
for the *.smackaho.st domain.

# Deployment

If you haven't set up your local production branch already, in your ideapi root, run

    git checkout -b production origin/production
    
Pull the production branch

    git pull origin production
    
Merge with the master branch

    git merge master
    git push
    
Deploy

    cap production deploy

Note, if it says you require a password, you will need to add your ssh key to the production server.
